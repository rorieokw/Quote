@page "/tradie/map"
@inject ApiService Api
@inject AuthService Auth
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<div class="map-page">
    <!-- Header -->
    <div class="page-header">
        <div class="header-content">
            <div class="header-icon">üó∫Ô∏è</div>
            <div>
                <h1>Job Map</h1>
                <p>@jobs.Count jobs nearby</p>
            </div>
        </div>
        <div class="header-actions">
            <button class="header-btn" @onclick="CenterOnMe" title="My Location">
                üìç
            </button>
            <button class="header-btn" @onclick="RefreshMap" disabled="@isLoading">
                @if (isLoading)
                {
                    <span class="spinner-small"></span>
                }
                else
                {
                    <span>üîÑ</span>
                }
            </button>
        </div>
    </div>

    <!-- Map Container -->
    <div class="map-container">
        @if (!mapInitialized)
        {
            <div class="map-loading">
                <div class="spinner"></div>
                <p>Loading map...</p>
            </div>
        }
        <div id="jobMap" class="map-element"></div>
    </div>

    <!-- Bottom Sheet with Job List -->
    <div class="bottom-sheet @(isSheetExpanded ? "expanded" : "")">
        <div class="sheet-handle" @onclick="ToggleSheet">
            <div class="handle-bar"></div>
        </div>

        <div class="sheet-header">
            <h2>Jobs by Suburb</h2>
            <span class="job-count">@jobsBySuburb.Count suburbs</span>
        </div>

        <div class="sheet-content">
            @if (!jobsBySuburb.Any())
            {
                <div class="empty-state">
                    <p>No jobs found in your area</p>
                </div>
            }
            else
            {
                @foreach (var suburb in jobsBySuburb.OrderByDescending(g => g.Count()))
                {
                    <div class="suburb-item" @onclick="() => FocusSuburb(suburb.First())">
                        <div class="suburb-info">
                            <span class="suburb-name">@suburb.Key</span>
                            <span class="suburb-postcode">@suburb.First().Postcode</span>
                        </div>
                        <span class="suburb-badge">@suburb.Count()</span>
                    </div>
                }
            }
        </div>
    </div>
</div>

<style>
    .map-page {
        height: 100vh;
        display: flex;
        flex-direction: column;
        background: #f7f8fb;
        position: relative;
    }

    .page-header {
        background: linear-gradient(135deg, #0f6cfb 0%, #5c9dff 100%);
        padding: 1rem 1.25rem;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 10;
    }

    .header-content {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .header-icon {
        font-size: 1.5rem;
    }

    .page-header h1 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 700;
    }

    .page-header p {
        margin: 0;
        opacity: 0.9;
        font-size: 0.8rem;
    }

    .header-actions {
        display: flex;
        gap: 0.5rem;
    }

    .header-btn {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        border: none;
        background: rgba(255,255,255,0.2);
        color: white;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }

    .header-btn:active {
        background: rgba(255,255,255,0.3);
    }

    .map-container {
        flex: 1;
        position: relative;
        min-height: 0;
    }

    .map-element {
        width: 100%;
        height: 100%;
    }

    .map-loading {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #f7f8fb;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 500;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(15,108,251,0.2);
        border-top-color: #0f6cfb;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-bottom: 1rem;
    }

    .spinner-small {
        width: 18px;
        height: 18px;
        border: 2px solid rgba(255,255,255,0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        display: inline-block;
    }

    @@keyframes spin { to { transform: rotate(360deg); } }

    /* Bottom Sheet */
    .bottom-sheet {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-radius: 20px 20px 0 0;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
        z-index: 50;
        max-height: 45%;
        transition: max-height 0.3s ease;
        display: flex;
        flex-direction: column;
    }

    .bottom-sheet.expanded {
        max-height: 70%;
    }

    .sheet-handle {
        padding: 12px;
        display: flex;
        justify-content: center;
        cursor: pointer;
    }

    .handle-bar {
        width: 40px;
        height: 4px;
        background: #d1d5db;
        border-radius: 2px;
    }

    .sheet-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 1.25rem 0.75rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .sheet-header h2 {
        margin: 0;
        font-size: 1rem;
        font-weight: 700;
        color: #1f2933;
    }

    .job-count {
        font-size: 0.8rem;
        color: #6b7280;
    }

    .sheet-content {
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem 0;
    }

    .suburb-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.875rem 1.25rem;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
    }

    .suburb-item:active {
        background: #f7f8fb;
    }

    .suburb-info {
        display: flex;
        flex-direction: column;
    }

    .suburb-name {
        font-weight: 600;
        color: #1f2933;
        font-size: 0.95rem;
    }

    .suburb-postcode {
        font-size: 0.8rem;
        color: #6b7280;
    }

    .suburb-badge {
        background: #0f6cfb;
        color: white;
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.25rem 0.6rem;
        border-radius: 10px;
    }

    .empty-state {
        text-align: center;
        padding: 2rem;
        color: #6b7280;
    }

    /* Leaflet overrides for mobile */
    :global(.leaflet-control-zoom) {
        border: none !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.15) !important;
    }

    :global(.leaflet-control-zoom a) {
        width: 36px !important;
        height: 36px !important;
        line-height: 36px !important;
        font-size: 18px !important;
    }

    :global(.leaflet-popup-content-wrapper) {
        border-radius: 12px !important;
    }
</style>

@code {
    private List<JobDto> jobs = new();
    private ILookup<string, JobDto> jobsBySuburb = Enumerable.Empty<JobDto>().ToLookup(j => "");
    private bool isLoading = true;
    private bool mapInitialized = false;
    private bool isSheetExpanded = false;

    protected override async Task OnInitializedAsync()
    {
        await Auth.InitializeAsync();
        if (!Auth.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InitializeMap();
            await LoadJobs();
        }
    }

    private async Task InitializeMap()
    {
        try
        {
            // Default to Sydney, Australia
            await JSRuntime.InvokeVoidAsync("jobMap.initialize", "jobMap", -33.8688, 151.2093, 11);
            mapInitialized = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Map init error: {ex.Message}");
        }
    }

    private async Task LoadJobs()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            jobs = await Api.GetJobsAsync();
            jobsBySuburb = jobs.ToLookup(j => j.SuburbName ?? "Unknown");

            // Update map markers
            if (mapInitialized && jobs.Any())
            {
                var markers = jobs.Select(j => new
                {
                    jobId = j.Id.ToString(),
                    title = j.Title,
                    suburbName = j.SuburbName,
                    tradeCategoryName = j.TradeCategoryName,
                    budgetMax = j.BudgetMax,
                    // Use postcode to generate approximate coordinates for demo
                    // In production, you'd have real lat/lng from the API
                    latitude = GetLatFromPostcode(j.Postcode),
                    longitude = GetLngFromPostcode(j.Postcode)
                }).ToList();

                await JSRuntime.InvokeVoidAsync("jobMap.setMarkers", markers);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Load jobs error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task RefreshMap()
    {
        await LoadJobs();
    }

    private async Task CenterOnMe()
    {
        try
        {
            var position = await JSRuntime.InvokeAsync<GeolocationResult>("geolocation.getCurrentPosition");
            await JSRuntime.InvokeVoidAsync("jobMap.addUserMarker", position.Latitude, position.Longitude);
            await JSRuntime.InvokeVoidAsync("jobMap.setCenter", position.Latitude, position.Longitude, 13);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Geolocation error: {ex.Message}");
        }
    }

    private async Task FocusSuburb(JobDto job)
    {
        var lat = GetLatFromPostcode(job.Postcode);
        var lng = GetLngFromPostcode(job.Postcode);
        await JSRuntime.InvokeVoidAsync("jobMap.setCenter", lat, lng, 14);
        isSheetExpanded = false;
    }

    private void ToggleSheet()
    {
        isSheetExpanded = !isSheetExpanded;
    }

    // Helper to generate approximate coordinates from postcode
    // Sydney postcodes start with 2, Melbourne with 3, Brisbane with 4, etc.
    private double GetLatFromPostcode(string postcode)
    {
        if (string.IsNullOrEmpty(postcode) || postcode.Length < 4) return -33.8688;

        var hash = postcode.GetHashCode();
        var offset = (hash % 100) / 1000.0;

        return postcode[0] switch
        {
            '2' => -33.8688 + offset, // NSW/Sydney
            '3' => -37.8136 + offset, // VIC/Melbourne
            '4' => -27.4698 + offset, // QLD/Brisbane
            '5' => -34.9285 + offset, // SA/Adelaide
            '6' => -31.9505 + offset, // WA/Perth
            '7' => -42.8821 + offset, // TAS/Hobart
            _ => -33.8688 + offset
        };
    }

    private double GetLngFromPostcode(string postcode)
    {
        if (string.IsNullOrEmpty(postcode) || postcode.Length < 4) return 151.2093;

        var hash = postcode.GetHashCode();
        var offset = (hash % 100) / 500.0;

        return postcode[0] switch
        {
            '2' => 151.2093 + offset, // NSW/Sydney
            '3' => 144.9631 + offset, // VIC/Melbourne
            '4' => 153.0251 + offset, // QLD/Brisbane
            '5' => 138.6007 + offset, // SA/Adelaide
            '6' => 115.8605 + offset, // WA/Perth
            '7' => 147.3272 + offset, // TAS/Hobart
            _ => 151.2093 + offset
        };
    }

    private class GeolocationResult
    {
        public double Latitude { get; set; }
        public double Longitude { get; set; }
    }
}
