@inject IJSRuntime JS

<div class="photo-markup-overlay @(IsVisible ? "visible" : "")">
    <div class="markup-container">
        <!-- Header -->
        <div class="markup-header">
            <button class="back-btn" @onclick="Cancel">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
            </button>
            <h1>Photo Markup</h1>
            <button class="done-btn" @onclick="Save">Done</button>
        </div>

        <!-- Canvas Area -->
        <div class="canvas-wrapper">
            <canvas id="markupCanvas"></canvas>
        </div>

        <!-- Tools Toolbar -->
        <div class="tools-toolbar">
            <button class="tool-btn @(activeTool == "pen" ? "active" : "")" @onclick='() => SetTool("pen")' title="Pen">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                    <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                </svg>
            </button>
            <button class="tool-btn @(activeTool == "arrow" ? "active" : "")" @onclick='() => SetTool("arrow")' title="Arrow">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M5 12h14M12 5l7 7-7 7"/>
                </svg>
            </button>
            <button class="tool-btn @(activeTool == "rectangle" ? "active" : "")" @onclick='() => SetTool("rectangle")' title="Rectangle">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                </svg>
            </button>
            <button class="tool-btn @(activeTool == "circle" ? "active" : "")" @onclick='() => SetTool("circle")' title="Circle">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="9"/>
                </svg>
            </button>
            <button class="tool-btn @(activeTool == "text" ? "active" : "")" @onclick="AddText" title="Text">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 7V4h16v3M9 20h6M12 4v16"/>
                </svg>
            </button>
            <button class="tool-btn @(activeTool == "eraser" ? "active" : "")" @onclick='() => SetTool("eraser")' title="Eraser">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 20H7L3 16c-.6-.6-.6-1.5 0-2.1L13.1 4c.6-.6 1.5-.6 2.1 0l6 6c.6.6.6 1.5 0 2.1L11 22"/>
                </svg>
            </button>
            <div class="tool-divider"></div>
            <button class="tool-btn" @onclick="Undo" title="Undo">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 7v6h6"/>
                    <path d="M3 13c0-4.97 4.03-9 9-9a9 9 0 0 1 6.36 2.64"/>
                </svg>
            </button>
            <button class="tool-btn" @onclick="Redo" title="Redo">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 7v6h-6"/>
                    <path d="M21 13c0-4.97-4.03-9-9-9a9 9 0 0 0-6.36 2.64"/>
                </svg>
            </button>
        </div>

        <!-- Color & Size Bar -->
        <div class="options-bar">
            <div class="color-options">
                <span class="option-label">Color:</span>
                @foreach (var color in colors)
                {
                    <button class="color-btn @(activeColor == color ? "active" : "")"
                            style="background-color: @color"
                            @onclick="() => SetColor(color)"></button>
                }
            </div>
            <div class="size-options">
                <span class="option-label">Size:</span>
                @foreach (var size in strokeSizes)
                {
                    <button class="size-btn @(activeSize == size.Value ? "active" : "")"
                            @onclick="() => SetStrokeWidth(size.Value)">@size.Label</button>
                }
            </div>
        </div>

        <!-- Bottom Actions -->
        <div class="bottom-actions">
            <button class="btn-clear" @onclick="Clear">Clear All</button>
            <button class="btn-save" @onclick="Save">Save Markup</button>
        </div>
    </div>
</div>

<style>
    .photo-markup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #1f2937;
        z-index: 9999;
        display: none;
        flex-direction: column;
    }

    .photo-markup-overlay.visible {
        display: flex;
    }

    .markup-container {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .markup-header {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        background: #111827;
        gap: 12px;
    }

    .back-btn {
        width: 40px;
        height: 40px;
        background: #374151;
        border: none;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        cursor: pointer;
    }

    .markup-header h1 {
        flex: 1;
        font-size: 1rem;
        font-weight: 600;
        color: white;
        margin: 0;
    }

    .done-btn {
        padding: 10px 20px;
        background: #0d6efd;
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
    }

    .canvas-wrapper {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px;
        overflow: hidden;
        background: #374151;
    }

    .canvas-wrapper canvas {
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .tools-toolbar {
        display: flex;
        justify-content: center;
        gap: 8px;
        padding: 12px 16px;
        background: #111827;
    }

    .tool-btn {
        width: 44px;
        height: 44px;
        background: #374151;
        border: 2px solid transparent;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #9ca3af;
        cursor: pointer;
        transition: all 0.15s;
    }

    .tool-btn:active {
        transform: scale(0.95);
    }

    .tool-btn.active {
        background: #0d6efd;
        color: white;
        border-color: #3b82f6;
    }

    .tool-divider {
        width: 1px;
        background: #4b5563;
        margin: 0 4px;
    }

    .options-bar {
        display: flex;
        justify-content: space-between;
        padding: 12px 16px;
        background: #1f2937;
        gap: 16px;
    }

    .color-options,
    .size-options {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .option-label {
        font-size: 0.75rem;
        color: #9ca3af;
        font-weight: 500;
    }

    .color-btn {
        width: 28px;
        height: 28px;
        border: 2px solid transparent;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.15s;
    }

    .color-btn.active {
        border-color: white;
        transform: scale(1.15);
    }

    .size-btn {
        padding: 6px 12px;
        background: #374151;
        border: 2px solid transparent;
        border-radius: 8px;
        color: #9ca3af;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
    }

    .size-btn.active {
        background: #4b5563;
        color: white;
        border-color: #6b7280;
    }

    .bottom-actions {
        display: flex;
        gap: 12px;
        padding: 16px;
        padding-bottom: max(16px, env(safe-area-inset-bottom));
        background: #111827;
    }

    .btn-clear {
        flex: 1;
        padding: 14px;
        background: #374151;
        color: #f87171;
        border: none;
        border-radius: 12px;
        font-size: 0.9375rem;
        font-weight: 600;
        cursor: pointer;
    }

    .btn-save {
        flex: 2;
        padding: 14px;
        background: #0d6efd;
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 0.9375rem;
        font-weight: 600;
        cursor: pointer;
    }
</style>

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public string? ImageUrl { get; set; }
    [Parameter] public string? ExistingAnnotationJson { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public EventCallback<MarkupResult> OnSave { get; set; }

    private string activeTool = "pen";
    private string activeColor = "#ef4444";
    private int activeSize = 3;
    private bool isInitialized = false;

    private string[] colors = new[] { "#ef4444", "#3b82f6", "#22c55e", "#eab308", "#1f2937" };
    private (string Label, int Value)[] strokeSizes = new[] { ("S", 2), ("M", 3), ("L", 5) };

    public class MarkupResult
    {
        public string AnnotatedImageBase64 { get; set; } = "";
        public string AnnotationJson { get; set; } = "";
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (IsVisible && !isInitialized)
        {
            await InitializeCanvas();
            isInitialized = true;
        }
    }

    private async Task InitializeCanvas()
    {
        try
        {
            // Get viewport dimensions (accounting for toolbars)
            var width = 350;  // Default mobile width
            var height = 400; // Default mobile height

            await JS.InvokeVoidAsync("photoMarkup.initialize", "markupCanvas", ImageUrl, width, height);

            if (!string.IsNullOrEmpty(ExistingAnnotationJson))
            {
                await JS.InvokeVoidAsync("photoMarkup.loadAnnotationJson", ExistingAnnotationJson);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing canvas: {ex.Message}");
        }
    }

    private async Task SetTool(string tool)
    {
        activeTool = tool;
        await JS.InvokeVoidAsync("photoMarkup.setTool", tool);
    }

    private async Task SetColor(string color)
    {
        activeColor = color;
        await JS.InvokeVoidAsync("photoMarkup.setColor", color);
    }

    private async Task SetStrokeWidth(int width)
    {
        activeSize = width;
        await JS.InvokeVoidAsync("photoMarkup.setStrokeWidth", width);
    }

    private async Task AddText()
    {
        activeTool = "text";
        await JS.InvokeVoidAsync("photoMarkup.addText", "Note");
    }

    private async Task Undo()
    {
        await JS.InvokeVoidAsync("photoMarkup.undo");
    }

    private async Task Redo()
    {
        await JS.InvokeVoidAsync("photoMarkup.redo");
    }

    private async Task Clear()
    {
        await JS.InvokeVoidAsync("photoMarkup.clear");
    }

    private async Task Cancel()
    {
        await Cleanup();
        await OnCancel.InvokeAsync();
    }

    private async Task Save()
    {
        try
        {
            var imageBase64 = await JS.InvokeAsync<string>("photoMarkup.exportImage");
            var annotationJson = await JS.InvokeAsync<string>("photoMarkup.getAnnotationJson");

            var result = new MarkupResult
            {
                AnnotatedImageBase64 = imageBase64,
                AnnotationJson = annotationJson
            };

            await Cleanup();
            await OnSave.InvokeAsync(result);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving markup: {ex.Message}");
        }
    }

    private async Task Cleanup()
    {
        isInitialized = false;
        await JS.InvokeVoidAsync("photoMarkup.dispose");
    }
}
