@page "/tradie/settings"
@page "/settings"
@using Quote.Shared.DTOs
@inject HttpClient Http
@inject AuthStateService AuthState
@inject IConfiguration Configuration

<PageTitle>Settings - Quote</PageTitle>

<div class="container py-4">
    <h1 class="h3 mb-4">Settings</h1>

    <!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <button class="nav-link @(activeTab == "general" ? "active" : "")" @onclick="@(() => activeTab = "general")">
                <i class="bi bi-gear me-1"></i>General
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link @(activeTab == "preferences" ? "active" : "")" @onclick="@(() => activeTab = "preferences")">
                <i class="bi bi-sliders me-1"></i>Job Preferences
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link @(activeTab == "availability" ? "active" : "")" @onclick="@(() => activeTab = "availability")">
                <i class="bi bi-lightning-charge me-1"></i>Availability
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link @(activeTab == "verification" ? "active" : "")" @onclick="@(() => activeTab = "verification")">
                <i class="bi bi-patch-check me-1"></i>Verification
            </button>
        </li>
    </ul>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary"></div>
        </div>
    }
    else
    {
        <!-- General Tab -->
        @if (activeTab == "general")
        {
            <div class="row">
                <div class="col-lg-8">
                    <!-- App Info -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-white">
                            <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Application Info</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-borderless mb-0">
                                <tbody>
                                    <tr>
                                        <td class="text-muted" style="width: 150px;">App Name</td>
                                        <td class="fw-semibold">@appName</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Version</td>
                                        <td>
                                            <span class="badge bg-primary fs-6">@appVersion</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Description</td>
                                        <td>@appDescription</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Account Info -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-white">
                            <h5 class="mb-0"><i class="bi bi-person me-2"></i>Account</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-borderless mb-0">
                                <tbody>
                                    <tr>
                                        <td class="text-muted" style="width: 150px;">Email</td>
                                        <td>@userEmail</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Account Type</td>
                                        <td>
                                            <span class="badge bg-success">Tradie</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <h6 class="fw-semibold mb-3">Quick Links</h6>
                            <div class="list-group list-group-flush">
                                <a href="/tradie/quotes" class="list-group-item list-group-item-action border-0">
                                    <i class="bi bi-file-text me-2"></i>My Quotes
                                </a>
                                <a href="/tradie/templates" class="list-group-item list-group-item-action border-0">
                                    <i class="bi bi-lightning me-2"></i>Quote Templates
                                </a>
                                <a href="/tradie/team" class="list-group-item list-group-item-action border-0">
                                    <i class="bi bi-people me-2"></i>Team Management
                                </a>
                                <a href="/tradie/portfolio" class="list-group-item list-group-item-action border-0">
                                    <i class="bi bi-images me-2"></i>Portfolio
                                </a>
                                <a href="/tradie/map" class="list-group-item list-group-item-action border-0">
                                    <i class="bi bi-map me-2"></i>Job Map
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Job Preferences Tab -->
        @if (activeTab == "preferences")
        {
            <div class="row">
                <div class="col-lg-8">
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-white">
                            <h5 class="mb-0"><i class="bi bi-sliders me-2"></i>Job Preferences</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Minimum Job Size</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" @bind="minJobSize" placeholder="0">
                                </div>
                                <small class="text-muted">Only show jobs with budgets above this amount</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Maximum Job Size</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" @bind="maxJobSize" placeholder="No limit">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Service Radius</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" @bind="serviceRadius" placeholder="25">
                                    <span class="input-group-text">km</span>
                                </div>
                            </div>
                            <button class="btn btn-primary" @onclick="SavePreferences">
                                <i class="bi bi-check-lg me-1"></i>Save Preferences
                            </button>
                        </div>
                    </div>

                    <!-- Blocked Suburbs -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-white">
                            <h5 class="mb-0"><i class="bi bi-geo-alt me-2"></i>Blocked Suburbs</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">Block suburbs you don't want to service.</p>

                            <div class="input-group mb-3">
                                <input type="text" class="form-control" @bind="newBlockedSuburb" placeholder="Enter suburb name or postcode">
                                <button class="btn btn-outline-danger" @onclick="BlockSuburb">
                                    <i class="bi bi-plus-lg"></i> Block
                                </button>
                            </div>

                            @if (blockedSuburbs.Any())
                            {
                                <div class="d-flex flex-wrap gap-2">
                                    @foreach (var suburb in blockedSuburbs)
                                    {
                                        <span class="badge bg-danger d-flex align-items-center gap-1 py-2 px-3">
                                            @suburb.SuburbName (@suburb.Postcode)
                                            <button class="btn-close btn-close-white ms-1" style="font-size: 0.6em;"
                                                    @onclick="() => UnblockSuburb(suburb.Postcode)"></button>
                                        </span>
                                    }
                                </div>
                            }
                            else
                            {
                                <p class="text-muted mb-0"><i class="bi bi-info-circle me-1"></i>No blocked suburbs</p>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Availability Tab -->
        @if (activeTab == "availability")
        {
            <div class="row">
                <div class="col-lg-8">
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-lightning-charge text-warning me-2"></i>Available Now</h5>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="availableNow"
                                       checked="@isAvailableNow" @onchange="ToggleAvailableNow" style="width: 3em; height: 1.5em;">
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-2">Let customers know you're available for same-day urgent work.</p>
                            @if (isAvailableNow)
                            {
                                <div class="alert alert-success mb-0">
                                    <i class="bi bi-check-circle me-2"></i>You're showing as available until @availableUntil?.ToString("h:mm tt")
                                </div>
                            }
                            else
                            {
                                <p class="text-muted mb-0">Toggle on to appear in "Available Now" searches.</p>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Verification Tab -->
        @if (activeTab == "verification")
        {
            <div class="row">
                <div class="col-lg-8">
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-white">
                            <h5 class="mb-0"><i class="bi bi-patch-check me-2"></i>Verification Status</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="p-3 rounded @(isLicenseVerified ? "bg-success bg-opacity-10" : "bg-light")">
                                        <div class="d-flex align-items-center">
                                            <i class="bi @(isLicenseVerified ? "bi-check-circle-fill text-success" : "bi-circle text-muted") fs-4 me-2"></i>
                                            <div>
                                                <strong>Licensed</strong>
                                                <small class="d-block text-muted">Trade license</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-3 rounded @(isInsuranceVerified ? "bg-success bg-opacity-10" : "bg-light")">
                                        <div class="d-flex align-items-center">
                                            <i class="bi @(isInsuranceVerified ? "bi-check-circle-fill text-success" : "bi-circle text-muted") fs-4 me-2"></i>
                                            <div>
                                                <strong>Insured</strong>
                                                <small class="d-block text-muted">Public liability</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-3 rounded @(isPoliceCheckVerified ? "bg-success bg-opacity-10" : "bg-light")">
                                        <div class="d-flex align-items-center">
                                            <i class="bi @(isPoliceCheckVerified ? "bi-check-circle-fill text-success" : "bi-circle text-muted") fs-4 me-2"></i>
                                            <div>
                                                <strong>Police Check</strong>
                                                <small class="d-block text-muted">Background verified</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <a href="#" class="btn btn-outline-primary">
                                    <i class="bi bi-upload me-1"></i>Upload Documents
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    private string activeTab = "general";
    private bool isLoading = true;

    // General tab
    private string appName = "Quote";
    private string appVersion = "1.0.0";
    private string appDescription = "Australia's Trade Marketplace";
    private string userEmail = "";

    // Availability tab
    private bool isAvailableNow = false;
    private DateTime? availableUntil;

    // Preferences tab
    private decimal? minJobSize;
    private decimal? maxJobSize;
    private int serviceRadius = 25;
    private string newBlockedSuburb = "";
    private List<BlockedSuburbDto> blockedSuburbs = new();

    // Verification tab
    private bool isLicenseVerified = false;
    private bool isInsuranceVerified = false;
    private bool isPoliceCheckVerified = false;

    protected override void OnInitialized()
    {
        // Load version from config
        appName = Configuration["App:Name"] ?? "Quote";
        appVersion = Configuration["App:Version"] ?? "1.0.0";
        appDescription = Configuration["App:Description"] ?? "Australia's Trade Marketplace";
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadSettings();
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadSettings()
    {
        try
        {
            // Try to get version from API as well (to ensure it matches)
            try
            {
                var versionResponse = await Http.GetFromJsonAsync<VersionInfo>("api/version");
                if (versionResponse != null)
                {
                    appName = versionResponse.Name;
                    appVersion = versionResponse.Version;
                    appDescription = versionResponse.Description;
                }
            }
            catch { }

            // Get user email from auth state (if available)
            // userEmail will be set from API response if available

            // Load blocked suburbs
            var suburbsResponse = await Http.GetFromJsonAsync<List<BlockedSuburbDto>>("api/tradie/blocked-suburbs");
            blockedSuburbs = suburbsResponse ?? new();

            // Load available now status
            var availableResponse = await Http.GetFromJsonAsync<AvailableNowDto>("api/tradie/available-now");
            if (availableResponse != null)
            {
                isAvailableNow = availableResponse.IsAvailableNow;
                availableUntil = availableResponse.AvailableUntil;
            }

            // Load preferences
            var prefsResponse = await Http.GetFromJsonAsync<JobPreferencesDto>("api/tradie/preferences");
            if (prefsResponse != null)
            {
                minJobSize = prefsResponse.MinJobSize;
                maxJobSize = prefsResponse.MaxJobSize;
                serviceRadius = prefsResponse.ServiceRadiusKm;
            }

            // Load verification status
            var verifyResponse = await Http.GetFromJsonAsync<VerificationStatusDto>("api/tradie/verification-status");
            if (verifyResponse != null)
            {
                isLicenseVerified = verifyResponse.IsLicensed;
                isInsuranceVerified = verifyResponse.IsInsured;
                isPoliceCheckVerified = verifyResponse.IsPoliceChecked;
            }
        }
        catch { }
    }

    private async Task ToggleAvailableNow()
    {
        isAvailableNow = !isAvailableNow;
        try
        {
            var request = new SetAvailableNowRequest(isAvailableNow, isAvailableNow ? 4 : 0);
            await Http.PutAsJsonAsync("api/tradie/available-now", request);
            if (isAvailableNow)
            {
                availableUntil = DateTime.Now.AddHours(4);
            }
        }
        catch { }
    }

    private async Task SavePreferences()
    {
        try
        {
            var request = new UpdateJobPreferencesRequest(minJobSize, maxJobSize, serviceRadius);
            await Http.PutAsJsonAsync("api/tradie/preferences", request);
        }
        catch { }
    }

    private async Task BlockSuburb()
    {
        if (string.IsNullOrWhiteSpace(newBlockedSuburb)) return;
        try
        {
            var request = new BlockSuburbRequest(newBlockedSuburb, newBlockedSuburb, "NSW", null);
            var response = await Http.PostAsJsonAsync("api/tradie/blocked-suburbs", request);
            if (response.IsSuccessStatusCode)
            {
                blockedSuburbs.Add(new BlockedSuburbDto(Guid.NewGuid(), newBlockedSuburb, newBlockedSuburb, "NSW", null));
                newBlockedSuburb = "";
            }
        }
        catch { }
    }

    private async Task UnblockSuburb(string postcode)
    {
        try
        {
            await Http.DeleteAsync($"api/tradie/blocked-suburbs/{postcode}");
            blockedSuburbs = blockedSuburbs.Where(s => s.Postcode != postcode).ToList();
        }
        catch { }
    }

    private record VersionInfo(string Name, string Version, string Description);
}
