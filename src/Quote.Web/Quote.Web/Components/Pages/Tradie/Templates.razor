@page "/tradie/templates"
@using Quote.Shared.DTOs
@inject HttpClient Http
@inject NavigationManager Navigation


<PageTitle>Quote Templates - Quote</PageTitle>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">Quote Templates</h1>
            <p class="text-muted mb-0">Save time with reusable quote templates</p>
        </div>
        <button class="btn btn-primary" @onclick="ShowCreateModal">
            <i class="bi bi-plus-lg me-2"></i>New Template
        </button>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (!templates.Any())
    {
        <div class="text-center py-5">
            <i class="bi bi-file-earmark-text fs-1 text-muted"></i>
            <h5 class="mt-3">No templates yet</h5>
            <p class="text-muted">Create templates for your common jobs to quote faster!</p>
            <button class="btn btn-primary" @onclick="ShowCreateModal">Create Your First Template</button>
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var template in templates)
            {
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100 border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0">@template.Name</h5>
                                <span class="badge bg-light text-dark">@template.TradeCategoryName</span>
                            </div>
                            @if (!string.IsNullOrEmpty(template.Description))
                            {
                                <p class="text-muted small mb-3">@template.Description</p>
                            }
                            <div class="row text-center mb-3">
                                <div class="col-4">
                                    <h6 class="text-primary mb-0">$@template.DefaultLabourCost.ToString("N0")</h6>
                                    <small class="text-muted">Labour</small>
                                </div>
                                <div class="col-4">
                                    <h6 class="text-success mb-0">$@((template.DefaultMaterialsCost ?? 0).ToString("N0"))</h6>
                                    <small class="text-muted">Materials</small>
                                </div>
                                <div class="col-4">
                                    <h6 class="mb-0">@template.DefaultDurationHours hrs</h6>
                                    <small class="text-muted">Duration</small>
                                </div>
                            </div>
                            @if (template.Materials.Any())
                            {
                                <div class="mb-3">
                                    <small class="text-muted">Materials:</small>
                                    <ul class="list-unstyled mb-0 small">
                                        @foreach (var material in template.Materials.Take(3))
                                        {
                                            <li>â€¢ @material.ProductName (@material.Quantity @material.Unit)</li>
                                        }
                                        @if (template.Materials.Count > 3)
                                        {
                                            <li class="text-muted">+ @(template.Materials.Count - 3) more</li>
                                        }
                                    </ul>
                                </div>
                            }
                        </div>
                        <div class="card-footer bg-transparent border-top-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="bi bi-bar-chart me-1"></i>Used @template.UsageCount times
                                </small>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => EditTemplate(template)">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteTemplate(template.Id)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<!-- Create/Edit Modal -->
@if (showModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(isEditing ? "Edit Template" : "New Template")</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <EditForm Model="templateModel" OnValidSubmit="SaveTemplate">
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label">Template Name *</label>
                                <InputText @bind-Value="templateModel.Name" class="form-control" placeholder="e.g., Standard Powerpoint Install" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Trade Category *</label>
                                <InputSelect @bind-Value="templateModel.TradeCategoryId" class="form-select">
                                    <option value="">Select...</option>
                                    @foreach (var cat in categories)
                                    {
                                        <option value="@cat.Id">@cat.Name</option>
                                    }
                                </InputSelect>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Description</label>
                                <InputTextArea @bind-Value="templateModel.Description" class="form-control" rows="2" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Labour Cost *</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <InputNumber @bind-Value="templateModel.DefaultLabourCost" class="form-control" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Materials Cost</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <InputNumber @bind-Value="templateModel.DefaultMaterialsCost" class="form-control" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Duration (hours) *</label>
                                <InputNumber @bind-Value="templateModel.DefaultDurationHours" class="form-control" />
                            </div>
                            <div class="col-12">
                                <label class="form-label">Default Notes</label>
                                <InputTextArea @bind-Value="templateModel.DefaultNotes" class="form-control" rows="2" placeholder="Notes that will be pre-filled when using this template..." />
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                        <button type="submit" class="btn btn-primary" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            @(isEditing ? "Save Changes" : "Create Template")
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@code {
    private List<QuoteTemplateDto> templates = new();
    private List<TradeCategoryDto> categories = new();
    private TemplateFormModel templateModel = new();
    private bool isLoading = true;
    private bool showModal = false;
    private bool isEditing = false;
    private bool isSaving = false;
    private Guid? editingTemplateId;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            var templatesTask = Http.GetFromJsonAsync<TemplateListResponse>("api/templates");
            var categoriesTask = Http.GetFromJsonAsync<List<TradeCategoryDto>>("api/tradecategories");

            await Task.WhenAll(templatesTask, categoriesTask);

            templates = (await templatesTask)?.Templates ?? new();
            categories = await categoriesTask ?? new();
        }
        catch
        {
            templates = new();
            categories = new();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ShowCreateModal()
    {
        templateModel = new TemplateFormModel();
        isEditing = false;
        editingTemplateId = null;
        showModal = true;
    }

    private void EditTemplate(QuoteTemplateDto template)
    {
        templateModel = new TemplateFormModel
        {
            Name = template.Name,
            Description = template.Description,
            TradeCategoryId = template.TradeCategoryId,
            DefaultLabourCost = template.DefaultLabourCost,
            DefaultMaterialsCost = template.DefaultMaterialsCost,
            DefaultDurationHours = template.DefaultDurationHours,
            DefaultNotes = template.DefaultNotes
        };
        isEditing = true;
        editingTemplateId = template.Id;
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
    }

    private async Task SaveTemplate()
    {
        isSaving = true;
        try
        {
            var request = new CreateTemplateRequest(
                templateModel.Name,
                templateModel.Description,
                templateModel.TradeCategoryId,
                templateModel.DefaultLabourCost,
                templateModel.DefaultMaterialsCost,
                templateModel.DefaultDurationHours,
                templateModel.DefaultNotes,
                null
            );

            HttpResponseMessage response;
            if (isEditing && editingTemplateId.HasValue)
            {
                response = await Http.PutAsJsonAsync($"api/templates/{editingTemplateId}", request);
            }
            else
            {
                response = await Http.PostAsJsonAsync("api/templates", request);
            }

            if (response.IsSuccessStatusCode)
            {
                await LoadData();
                CloseModal();
            }
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task DeleteTemplate(Guid id)
    {
        // TODO: Add confirmation dialog
        await Http.DeleteAsync($"api/templates/{id}");
        await LoadData();
    }

    private record TradeCategoryDto(Guid Id, string Name);

    private class TemplateFormModel
    {
        public string Name { get; set; } = string.Empty;
        public string? Description { get; set; }
        public Guid TradeCategoryId { get; set; }
        public decimal DefaultLabourCost { get; set; } = 200;
        public decimal? DefaultMaterialsCost { get; set; }
        public int DefaultDurationHours { get; set; } = 2;
        public string? DefaultNotes { get; set; }
    }
}
