@using Quote.Shared.DTOs
@inject HttpClient Http

<div class="card border-0 shadow-sm @(isAvailable ? "border-success border-2" : "")">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h6 class="mb-1">
                    <i class="bi bi-lightning-charge-fill @(isAvailable ? "text-success" : "text-muted") me-2"></i>
                    Available Now
                </h6>
                <small class="text-muted">
                    @if (isAvailable && availableUntil.HasValue)
                    {
                        <span>Available until @availableUntil.Value.ToString("h:mm tt")</span>
                    }
                    else
                    {
                        <span>Let customers know you can take urgent work today</span>
                    }
                </small>
            </div>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="availableNow"
                       checked="@isAvailable" @onchange="ToggleAvailability"
                       style="width: 3rem; height: 1.5rem; cursor: pointer;" />
            </div>
        </div>

        @if (isAvailable)
        {
            <div class="mt-3">
                <small class="text-muted d-block mb-2">How long are you available?</small>
                <div class="d-flex gap-2">
                    @foreach (var hours in new[] { 2, 4, 8 })
                    {
                        <button type="button"
                                class="btn btn-sm @(selectedHours == hours ? "btn-success" : "btn-outline-secondary")"
                                @onclick="() => SetHours(hours)">
                            @hours hrs
                        </button>
                    }
                    <button type="button"
                            class="btn btn-sm @(selectedHours == 0 ? "btn-success" : "btn-outline-secondary")"
                            @onclick="() => SetHours(0)">
                        Until midnight
                    </button>
                </div>
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public EventCallback<bool> OnStatusChanged { get; set; }

    private bool isAvailable = false;
    private DateTime? availableUntil;
    private int selectedHours = 4;

    protected override async Task OnInitializedAsync()
    {
        await LoadStatus();
    }

    private async Task LoadStatus()
    {
        try
        {
            var status = await Http.GetFromJsonAsync<AvailableNowDto>("api/tradie/available-now");
            if (status != null)
            {
                isAvailable = status.IsAvailableNow;
                availableUntil = status.AvailableUntil;
            }
        }
        catch
        {
            // Ignore - use defaults
        }
    }

    private async Task ToggleAvailability(ChangeEventArgs e)
    {
        isAvailable = (bool)(e.Value ?? false);
        await UpdateAvailability();
    }

    private async Task SetHours(int hours)
    {
        selectedHours = hours;
        await UpdateAvailability();
    }

    private async Task UpdateAvailability()
    {
        try
        {
            var request = new SetAvailableNowRequest(isAvailable, isAvailable ? selectedHours : null);
            var response = await Http.PutAsJsonAsync("api/tradie/available-now", request);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<AvailableNowDto>();
                if (result != null)
                {
                    availableUntil = result.AvailableUntil;
                }
                await OnStatusChanged.InvokeAsync(isAvailable);
            }
        }
        catch
        {
            // Revert on error
            isAvailable = !isAvailable;
        }
    }
}
